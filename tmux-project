#!/usr/bin/env bash

SCRIPT_NAME=${0##*/}
VERSION=0.0.0
PROJECT_DIR="$HOME/.config/tmux-project"

usage() {
  cat << EOF
usage: ${SCRIPT_NAME} <project name>

options:
  -h, --help       Display this help message
  -v, --version    Display the version number

EOF

}

version() {
  cat << EOF
tmux-project ${VERSION}

EOF

}

# Transform long options to short options
for arg in "$@"; do
  shift
  case "$arg" in
    "--help")
      set -- "$@" "-h"
      ;;
    "--version")
      set -- "$@" "-v"
      ;;
    *)
      set -- "$@" "$arg"
      ;;
  esac
done

# Parse short options
while getopts "hv" opt; do
  case "$opt" in
    "h")
      usage
      exit 0
      ;;
    "v")
      version
      exit 0
      ;;
    "?")
      usage >&2
      exit 1
      ;;
  esac
done

# Remove options from positional parameters
shift $(expr 0)



if [ $# -ne 1 ]; then
  usage
  exit 1
fi

PROJECT=$1

if [ ! -f "$PROJECT_DIR/$PROJECT" ]; then
  echo "$SCRIPT_NAME: '$PROJECT' not found in $PROJECT_DIR"
  exit 1
fi

if ! tmux has-session -t "$PROJECT" > /dev/null 2>&1; then
  TMUX='' tmux new-session -d -s "$PROJECT"
  xargs -L1 tmux < "$PROJECT_DIR/$PROJECT"
  tmux select-window -t 1
fi

if [ -z "$TMUX" ]; then
  tmux attach -t "$PROJECT"
else
  tmux switch-client -t "$PROJECT"
fi
